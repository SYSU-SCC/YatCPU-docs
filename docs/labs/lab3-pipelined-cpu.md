# 流水线 CPU

在完成单周期 CPU 实验后，你已经对 CPU 的原理和结构已经有了基本的了解。但单周期的 CPU 设计中，关键路径太长，频率难以提升。

在本实验中，你将学习到：

- 使用三级流水线设计缩短关键路径
- 正确处理流水线阻塞与清空
- 使用转发逻辑减少流水线阻塞

## 流水线寄存器

流水线寄存器是在流水线中起缓存作用的寄存器，目的是缩短关键路径。它的基本功能非常简单，在每一个时钟周期，根据复位（流水线清空）或阻塞（流水线暂停）的状态，将寄存器内容清空、保持或设置为新的值。寄存器的输出则是寄存器中保存的值。为了方便复用，我们可以定义一个带参数的 `PipelineRegister` 模块，用来实现不同数据位宽的流水线寄存器。

模块的输入信号包括：新的数据值、阻塞信号、复位信号，输出信号则是当前寄存器的数据值。模块的输入信号以及输出信号已经定义好，相关代码文件位于 `src/main/scala/riscv/core/PipelineRegister.scala`，请在 `// Lab2(PipelineRegister)` 注释处填入代码，使其能通过 `PipelineRegisterTest` 测试。

## 流水线清空

在发生程序跳转的时候，跳转指令之后的还在流水线中的指令都需要清空。这种情况下，由执行单元向控制单元拉起清空信号，控制单元将清空信号传递给流水线寄存器，清空当前流水线寄存器的内容。然后，取指模块从新的 PC 寄存器指定的指令地址重新开始取指，流水线恢复执行。

## 流水线阻塞

在执行一个周期无法完成的指令的时候，例如访存操作，当前指令之后的所有指令需要等待当前指令执行完成才能继续执行。这时候，流水线中还没执行的指令是有效的，所以不需要清空流水线。此时，执行单元向控制单元拉起阻塞信号，控制单元将阻塞信号传递给流水线寄存器，流水线寄存器则保持当前内容不变，等待阻塞信号解除后才接受从上一个阶段传递过来的新的值，流水线恢复执行。取指模块在流水线阻塞的时候，暂停取指操作。

## 扩展实验

### 五级流水线设计

在三级流水线中，执行阶段逻辑复杂，仍然可能导致较大的延迟。为了进一步缩短关键路径，我们可以扩展流水线级数，将执行阶段进一步分为 ALU 阶段、访存阶段以及写回阶段。

在五级流水线中，由于写回阶段在靠后的位置，有可能一个指令的源操作数在 ALU 阶段时还没有写回。这种情况下，会产生数据竞争。一种解决数据竞争的方法是直接阻塞流水线，这种方法实现简单，延迟较低，但是会产生流水线气泡，降低执行效率。另一种减少流水线气泡的方法是使用转发逻辑，将写回阶段或访存阶段的结果转发给 ALU 单元。使用转发逻辑的设计虽然能减少流水线气泡，但是会使得电路变得更复杂，能耗上升，可能会对时钟频率产生一定影响。